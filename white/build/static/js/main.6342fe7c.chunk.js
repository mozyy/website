(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{46:function(e){e.exports={websocketPort:"6503",development:{url:"localhost",websocket:"ws://localhost:6503"},production:{url:"yyue.dev",websocket:"wss://yyue.dev:6503"}}},56:function(e,n,t){e.exports=t(78)},61:function(e,n,t){},62:function(e,n,t){},78:function(e,n,t){"use strict";t.r(n);var a=t(0),r=t.n(a),o=t(9),c=t.n(o),i=(t(61),t(102)),s=(t(62),t(5)),u=t.n(s),l=t(10),d=t(41),f=t(51),h=t(79),p=t(42),v=t.n(p),g=t(106),w=t(105),b=t(104),m=t(49),k=t.n(m),C=t(47),y=t.n(C),E=t(43),O=t(44),j=t(52),x=t(26),S=t(45),P=t(53),D=t(46).production.websocket,L=function(e){var n=JSON.stringify(e);return(new TextEncoder).encode(n)},M=function(e){var n=(new TextDecoder).decode(e);return JSON.parse(n)},T=function(e,n){e.send(L(n))},R=console.log,N=console.error,A=function(e){R("Closing the call"),e&&(R("--\x3e Closing the peer connection"),e.ontrack=null,e.onicecandidate=null,e.oniceconnectionstatechange=null,e.onsignalingstatechange=null,e.onicegatheringstatechange=null,e.onnegotiationneeded=null,e.getTransceivers().forEach(function(e){e.stop()}),e.close())},W=function(e,n,t,a){return Object(l.a)(u.a.mark(function r(){var o,c;return u.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return R("*** Negotiation needed"),r.prev=1,R("---\x3e Creating offer"),r.next=5,e.createOffer();case 5:if(o=r.sent,"stable"==e.signalingState){r.next=9;break}return R("     -- The connection isn't stable yet; postponing..."),r.abrupt("return");case 9:return R("---\x3e Setting local description to the offer"),r.next=12,e.setLocalDescription(o);case 12:R("---\x3e Sending the offer to the remote peer"),c={kind:"video-offer",uid:t,target:a,value:{sdp:e.localDescription}},T(n,c),r.next=21;break;case 17:r.prev=17,r.t0=r.catch(1),R("*** The following error occurred while handling the negotiationneeded event:"),N(r.t0);case 21:case 22:case"end":return r.stop()}},r,null,[[1,17]])}))},I=function(e){R("*** Track event",e.streams[0])},U=window.location.hostname,B=function(e,n,t){var a=new RTCPeerConnection({iceServers:[{urls:"turn:"+U,username:"webrtc",credential:"turnserver"}]});return a.onicecandidate=function(e,n,t){return function(a){if(a.candidate){R("*** Outgoing ICE candidate: "+a.candidate.candidate);var r={kind:"new-ice-candidate",uid:n,target:t,value:{candidate:a.candidate}};T(e,r)}}}(e,n,t),a.oniceconnectionstatechange=function(e){return function(n){switch(R("*** ICE connection state changed to "+e.iceConnectionState),e.iceConnectionState){case"closed":case"failed":case"disconnected":A(e)}}}(a),a.onicegatheringstatechange=function(e){return function(n){R("*** ICE gathering state changed to: "+e.iceGatheringState)}}(a),a.onsignalingstatechange=function(e){return function(n){switch(R("*** WebRTC signaling state changed to: "+e.signalingState),e.signalingState){case"closed":A(e)}}}(a),a.ontrack=I,a},J=console.log,V=console.warn,F=function(e){return e.data.arrayBuffer().then(M)},H=function(e){function n(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{channel:"testChannel"};return Object(E.a)(this,n),(e=Object(j.a)(this,Object(x.a)(n).call(this))).options=void 0,e.conn=void 0,e.userlist=[],e.connPeers=new Map,e.dataChannels=new Map,e.uid=0,e.handleVideoOfferMsg=function(){var n=Object(l.a)(u.a.mark(function n(t,a){var r,o,c;return u.a.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(null==(r=e.connPeers.get(t))&&(r=e.handleCreatePeerConn(t)),J("Received video chat offer from "+t),o=new RTCSessionDescription(a.sdp),"stable"==r.signalingState){n.next=11;break}return J("  - But the signaling state isn't stable, so triggering rollback"),n.next=8,Promise.all([r.setLocalDescription({type:"rollback"}),r.setRemoteDescription(o)]).catch(function(e){return console.log("setLocalDescription: ",e)});case 8:return n.abrupt("return");case 11:return J("  - Setting remote description"),n.next=14,r.setRemoteDescription(o);case 14:return J("---\x3e Creating and sending answer to caller"),n.t0=r,n.next=18,r.createAnswer();case 18:return n.t1=n.sent,n.next=21,n.t0.setLocalDescription.call(n.t0,n.t1);case 21:c={kind:"video-answer",uid:e.uid,target:t,value:{sdp:r.localDescription}},T(e.conn,c);case 23:case"end":return n.stop()}},n)}));return function(e,t){return n.apply(this,arguments)}}(),e.options=t,e}return Object(S.a)(n,e),Object(O.a)(n,[{key:"init",value:function(){var e=Object(l.a)(u.a.mark(function e(){return u.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise(function(e,n){var t=new WebSocket(D);t.addEventListener("open",function(n){e(t)}),t.addEventListener("error",function(e){n(e)})});case 2:return this.conn=e.sent,this.addListener(),e.next=6,this.join();case 6:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"join",value:function(){var e=this,n={kind:"join",uid:this.uid,value:{channel:this.options.channel}},t=this.conn;return t.send(L(n)),new Promise(function(n,a){var r=function(){var o=Object(l.a)(u.a.mark(function o(c){var i;return u.a.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,F(c);case 2:i=o.sent,o.t0=i.kind,o.next="join-success"===o.t0?6:"join-failure"===o.t0?9:12;break;case 6:e.dispatchEvent(new CustomEvent("join-success",{detail:i.value})),t.removeEventListener("message",r),n(i);case 9:e.dispatchEvent(new CustomEvent("join-failure",{detail:i.value})),t.removeEventListener("message",r),a("join-failure");case 12:return o.abrupt("return",i);case 13:case"end":return o.stop()}},o)}));return function(e){return o.apply(this,arguments)}}();t.addEventListener("message",r)})}},{key:"createPeerConnection",value:function(e){return B.call(this,this.conn,this.uid,e)}},{key:"dataChannelsSend",value:function(e){var n=L(e);this.dataChannels.forEach(function(e){try{e.send(n)}catch(t){console.log("send data channel message failed: ",t)}})}},{key:"addListener",value:function(){var e=this,n=this.conn;n.addEventListener("close",function(n){console.log(n),e.dispatchEvent(n)}),n.addEventListener("message",function(){var n=Object(l.a)(u.a.mark(function n(t){var a,r,o,c,i,s;return u.a.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,F(t);case 2:a=n.sent,console.log("message: ",a),e.dispatchEvent(t),r=a.kind,o=a.value,c=a.uid,i=a.target,n.t0=r,n.next="join-success"===n.t0?9:"userlist"===n.t0?11:"user-joined"===n.t0?13:"video-offer"===n.t0?17:"video-answer"===n.t0?19:"new-ice-candidate"===n.t0?21:"hang-up"===n.t0?23:25;break;case 9:return e.uid=i,n.abrupt("break",27);case 11:return e.userlist=o,n.abrupt("break",27);case 13:return s=e.handleCreatePeerConn(c),W(s,e.conn,e.uid,c)(),e.handleCreateDataChannel(c),n.abrupt("break",27);case 17:return e.handleVideoOfferMsg(c,o),n.abrupt("break",27);case 19:return e.handleVideoAnswerMsg(c,o),n.abrupt("break",27);case 21:return e.handleNewICECandidateMsg(c,o),n.abrupt("break",27);case 23:return e.handleHangUpMsg(c,o),n.abrupt("break",27);case 25:V("Unknown message received:"),V(a);case 27:case"end":return n.stop()}},n)}));return function(e){return n.apply(this,arguments)}}())}},{key:"handleVideoAnswerMsg",value:function(){var e=Object(l.a)(u.a.mark(function e(n,t){var a;return u.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return J("*** Call recipient has accepted our call"),a=new RTCSessionDescription(t.sdp),e.next=4,this.connPeers.get(n).setRemoteDescription(a);case 4:case"end":return e.stop()}},e,this)}));return function(n,t){return e.apply(this,arguments)}}()},{key:"handleNewICECandidateMsg",value:function(){var e=Object(l.a)(u.a.mark(function e(n,t){var a;return u.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=new RTCIceCandidate(t.candidate),J("*** Adding received ICE candidate: "+JSON.stringify(a)),e.next=4,this.connPeers.get(n).addIceCandidate(a);case 4:case"end":return e.stop()}},e,this)}));return function(n,t){return e.apply(this,arguments)}}()},{key:"handleHangUpMsg",value:function(e,n){A(this.connPeers.get(e))}},{key:"handleCreatePeerConn",value:function(e){var n=this,t=this.createPeerConnection(e);return this.connPeers.set(e,t),t.addEventListener("datachannel",function(e){var t=e.channel;n.handleCreateDataChanneled(Number(t.label),t)}),t}},{key:"handleCreateDataChannel",value:function(e){var n=this.connPeers.get(e).createDataChannel(String(this.uid));return this.handleCreateDataChanneled(e,n),n}},{key:"handleCreateDataChanneled",value:function(e,n){var t=this,a=function(){console.log("current data channel state: ",n.readyState)};return n.addEventListener("open",a),n.addEventListener("close",a),n.addEventListener("message",function(e){t.dispatchEvent(new CustomEvent("datachannelmessage",{detail:e}))}),this.dataChannels.set(e,n),n}},{key:"handleClose",value:function(){this.conn&&this.conn.close(),this.connPeers.forEach(function(e){return e.close()}),this.dataChannels.forEach(function(e){return e.close()})}}]),n}(Object(P.a)(EventTarget)),G=function(){var e=Object(l.a)(u.a.mark(function e(){var n,t=arguments;return u.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.length>0&&void 0!==t[0]?t[0]:{channel:"testChannel"},n=new H,e.next=4,n.init();case 4:return e.abrupt("return",n);case 5:case"end":return e.stop()}},e)}));return function(){return e.apply(this,arguments)}}();function X(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,a)}return t}var Y=Object(h.a)(function(e){return{root:{width:"100%",height:"100vh",display:"block",touchAction:"none"},speedDial:{position:"absolute",bottom:e.spacing(2),right:e.spacing(3)}}}),$=function(e){var n,t={x:0,y:0};switch(e.type){case"touchstart":case"touchmove":case"touchend":n=e.changedTouches[0];break;case"mousedown":case"mousemove":case"mouseup":default:n=e}return t.x=n.clientX,t.y=n.clientY,t},q=!1,z=function(e){var n=Y();console.log("run function components");var t=Object(a.useRef)(null),o=Object(a.useRef)(""),c=Object(a.useState)(!1),i=Object(f.a)(c,2),s=i[0],h=i[1],p=Object(a.useRef)([]),m=Object(a.useRef)(null),C=Object(a.useRef)(),E=function(e){var n=t.current.getBoundingClientRect(),a=p.current[p.current.length-1],r={x:Math.round(3240*(e.x-n.left)/n.width),y:Math.round(3240*(e.y-n.top)/n.height)};a.points.push(r),function(e,n){e.strokeStyle=n.color,e.lineWidth=15,e.beginPath(),e.moveTo(n.points[0].x,n.points[0].y),n.points.forEach(function(n){e.lineTo(n.x,n.y)}),e.stroke()}(t.current.getContext("2d"),a)},O=function(e){var n=C.current;if(n){var t=function(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?X(t,!0).forEach(function(n){Object(d.a)(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):X(t).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}({},e,{uid:n.uid});n.dataChannelsSend(t)}},j=function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},a=v()(n,16);return{start:function(n){q=!0,e($(n))},move:function(e){q&&(e.stopPropagation(),a($(e)))},stop:function(e){q=!1,t($(e))}}}(function(e){p.current.push({color:o.current,points:[]}),E(e),O({kind:"pointStart",value:e})},function(e){E(e),O({kind:"pointMove",value:e})}),x=[{icon:r.a.createElement(y.a,null),name:"Save"},{icon:r.a.createElement(k.a,null),name:"color",hanler:function(){m.current.click(),h(!1)}}];return Object(a.useEffect)(function(){var e=function(e){var n=e.detail,t=M(n.data);switch(console.log(t),t.kind){case"pointStart":p.current.push({color:o.current,points:[]}),E(t.value);break;case"pointMove":E(t.value);break;case"colorChange":o.current=t.value}};return function(){var n=Object(l.a)(u.a.mark(function n(){var t;return u.a.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,G();case 2:t=n.sent,window.conn=C.current=t,t.addEventListener("datachannelmessage",e);case 5:case"end":return n.stop()}},n)}));return function(){return n.apply(this,arguments)}}()(),function(){var n=C.current;n&&(n.removeEventListener("datachannelmessage",e),n.handleClose())}},[]),r.a.createElement("div",null,r.a.createElement("canvas",{className:n.root,ref:t,height:3240,width:3240,onMouseDown:j.start,onMouseMove:j.move,onMouseUp:j.stop,onTouchStart:j.start,onTouchMove:j.move,onTouchEnd:j.stop}),r.a.createElement(g.a,{ariaLabel:"SpeedDial",className:n.speedDial,icon:r.a.createElement(w.a,null),onClick:function(){return h(function(e){return!e})},onBlur:function(){return h(!1)},onClose:function(){return h(!1)},onFocus:function(){return h(!0)},onMouseEnter:function(){return h(!0)},onMouseLeave:function(){return h(!1)},open:s},x.map(function(e){return r.a.createElement(b.a,{key:e.name,icon:e.icon,tooltipTitle:e.name,onClick:e.hanler||console.log})})),r.a.createElement("input",{ref:m,type:"color",hidden:!0,onChange:function(e){var n=e.target.value;o.current=n,O({kind:"colorChange",value:n})}}))},K=function(){return r.a.createElement(r.a.Fragment,null,r.a.createElement(i.a,null),r.a.createElement("div",{className:"App"},r.a.createElement(z,null)))},Q=Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));function Z(e,n){navigator.serviceWorker.register(e).then(function(e){e.onupdatefound=function(){var t=e.installing;null!=t&&(t.onstatechange=function(){"installed"===t.state&&(navigator.serviceWorker.controller?(console.log("New content is available and will be used when all tabs for this page are closed. See https://bit.ly/CRA-PWA."),n&&n.onUpdate&&n.onUpdate(e)):(console.log("Content is cached for offline use."),n&&n.onSuccess&&n.onSuccess(e)))})}}).catch(function(e){console.error("Error during service worker registration:",e)})}c.a.render(r.a.createElement(K,null),document.getElementById("root")),function(e){if("serviceWorker"in navigator){if(new URL("",window.location.href).origin!==window.location.origin)return;window.addEventListener("load",function(){var n="".concat("","/service-worker.js");Q?(function(e,n){fetch(e).then(function(t){var a=t.headers.get("content-type");404===t.status||null!=a&&-1===a.indexOf("javascript")?navigator.serviceWorker.ready.then(function(e){e.unregister().then(function(){window.location.reload()})}):Z(e,n)}).catch(function(){console.log("No internet connection found. App is running in offline mode.")})}(n,e),navigator.serviceWorker.ready.then(function(){console.log("This web app is being served cache-first by a service worker. To learn more, visit https://bit.ly/CRA-PWA")})):Z(n,e)})}}({onSuccess:function(e){console.log("onSuccess",e)},onUpdate:function(e){console.log("onUpdate",e)}})}},[[56,1,2]]]);
//# sourceMappingURL=main.6342fe7c.chunk.js.map